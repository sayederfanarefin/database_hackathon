

<html>

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>User Profile | Dashboard</title>

    <!-- Custom fonts for this template-->
    <link th:href="@{/app-assets/vendor/fontawesome-free/css/all.min.css}" rel="stylesheet" type="text/css">
    <link
            href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
            rel="stylesheet">

    <link
            href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
            rel="stylesheet">


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css"/>


    <!-- Custom styles for this template-->
    <link th:href="@{/app-assets/css/sb-admin-2.min.css}" rel="stylesheet">

    <style>
        .profile-image {
            width: 130px;
            height: 130px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 20px;
            border: solid;
            border-width: 2px;
            border-color: rgba(77, 115, 223, 0.53);
        }


        .wrapper {
            min-height: 100%;
            flex;
            flex-direction: column;
        }

        footer {
            flex-shrink: 0;
        }
        .centered-container {
            position: absolute;
            top: 50%;
            left: 56%;
            transform: translate(-50%, -50%);
            /*background-color: #fff;*/
            /*border-radius: 10px;*/
            /*box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);*/
            /*padding: 20px;*/
            text-align: center;
        }
    </style>



</head>

<body id="page-top">

<!-- Page Wrapper -->
<div id="wrapper">

    <div th:replace="user_sidebar :: user_sidebar"></div>

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">

        <!-- Main Content -->
        <div id="content">

            <!-- Topbar -->

            <div th:replace="user_navbar :: user_navbar"></div>

            <!-- Begin Page Content -->
            <div class="container-fluid">

                <div class="modal" id="loadingModal" tabindex="-1" role="dialog" style="position: fixed;
    top: 0;
    left: 0;
    z-index: 1040;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(15px);">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-body text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Running... Please wait.</span>
                                </div>
                                <p>Running... Please wait.</p>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="row">
                        <div class="col-8">
                            <div id="tab1">
                                <div class="card" style="width: auto;">
                                    <div class="card-header" style=" text-align: center;">
                                        User Profile
                                    </div>

                                    <div class="card-body">

                                        <div style=" text-align: center;">

                                            <img th:src="${user.pathToProPic}" alt="Profile Image" id="proPicMain" class="profile-image">

                                        </div>
                                        <div class="card" style="width: auto;">
                                            <ul class="list-group list-group-flush">
                                                <li class="list-group-item" th:text="'Name: ' + ${user.firstName} + ' ' + ${user.lastName}">Name: Sayed Erfan Arefin</li>
                                                <li class="list-group-item" th:text="'Email: ' + ${user.email}">erfanjordison@gmail.com</li>
                                                <li class="list-group-item" th:text="'Database User Name: ' + ${user.databaseUserName}">Kick Cyber</li>
                                                <li class="list-group-item" th:text="'Database Name: ' + ${user.databaseName}">Kick Cyber</li>
                                                <li class="list-group-item" id="teamNameMain" th:text="'Team Name: ' + ${user.teamName}">Kick Cyber</li>
                                            </ul>
                                        </div>

                                    </div>

                                    <div class="card-footer">
                                        <button class="btn btn-primary btn-block" type="submit" onclick="editProfile()" >Edit Profile</button>
                                    </div>
                                </div>
                            </div>

                            <div id="tab2" style="display: none">
                                <div class="card" style="width: auto;">
                                    <div class="card-header" style=" text-align: center;">
                                        Edit User Profile
                                    </div>

                                    <div class="card-body">
                                        <form  id="updateUserForm" method="POST" enctype="multipart/form-data" style="padding: 20px;" >

                                        <div style=" text-align: center;">

                                            <img th:src="${user.pathToProPic}" id="proPicSub" alt="Profile Image" class="profile-image">


                                            <div class="mb-3">
                                                <label for="profileImageUpload" class="form-label">Change profile picture</label>
                                                <input class="form-control" type="file" id="profileImageUpload" name="profileImageUpload" accept="image/*">
                                            </div>


                                        </div>
                                        <div class="card" style="width: 100%;padding: 18px;">

                                                <div class="form-group row">

                                                    <div class="col px-1 mb-2">
                                                        <label for="firstName" class="ms-2 position-absolute">
                                                            <span class="h6 small bg-white text-muted px-1">First Name</span>
                                                        </label>
                                                        <input type="text" class="form-control mt-2" id="firstName" style="cursor: not-allowed;" name="firstName" disabled readonly th:value="${user.firstName}">
                                                    </div>


                                                    <div class="col px-1 mb-2">
                                                        <label for="lastName" class="ms-2 position-absolute" style="margin-top: -0.25rem !important">
                                                            <span class="h6 small bg-white text-muted px-1">Last Name</span>
                                                        </label>
                                                        <input type="text" class="form-control mt-2" style="cursor: not-allowed;" id="lastName" name="lastName" disabled readonly th:value="${user.lastName}">
                                                    </div>
                                                </div>

                                                <div class="form-group row">
                                                    <div class="col px-1 mb-2">
                                                        <label for="teamName" class="ms-2 position-absolute" style="margin-top: -0.25rem !important">
                                                            <span class="h6 small bg-white text-muted px-1">Team Name</span>
                                                        </label>
                                                        <input type="text" class="form-control mt-2" id="teamName" name="teamName"  th:value="${user.teamName}">
                                                        <span id="teamNameError" class="alert alert-danger col-sm-12" style="display:none"></span>
                                                    </div>
                                                </div>


                                                <div class="form-group row">

                                                    <div class="col px-1 mb-2">
                                                        <label for="email" class="ms-2 position-absolute" style="margin-top: -0.25rem !important">
                                                            <span class="h6 small bg-white text-muted px-1">Email</span>
                                                        </label>
                                                        <input type="email" class="form-control mt-2" id="email" style="cursor: not-allowed;" name="email"  th:value="${user.email}" disabled readonly>

                                                    </div>

                                                </div>

                                                <div class="form-group row">
                                                    <div class="col px-1 mb-2">
                                                        <label for="databaseUserName" class="ms-2 position-absolute" style="margin-top: -0.25rem !important">
                                                            <span class="h6 small bg-white text-muted px-1">DB User Name</span>
                                                        </label>
                                                        <input type="text" class="form-control mt-2" id="databaseUserName" style="cursor: not-allowed;" name="databaseUserName" th:value="${user.databaseUserName}" disabled readonly>


                                                    </div>

                                                    <div class="col px-1 mb-2">
                                                        <label for="databaseName" class="ms-2 position-absolute" style="margin-top: -0.25rem !important">
                                                            <span class="h6 small bg-white text-muted px-1">DB Name</span>
                                                        </label>
                                                        <input type="text" class="form-control mt-2" id="databaseName" style="cursor: not-allowed;" name="databaseName" th:value="${user.databaseName}" disabled readonly>


                                                    </div>
                                                </div>


                                                <div class="form-group row">
                                                    <div class="col px-1 mb-2">
                                                        <label for="password" class="ms-2 position-absolute" style="margin-top: -0.25rem !important">
                                                            <span class="h6 small bg-white text-muted px-1">Password</span>
                                                        </label>
                                                        <input type="password" class="form-control mt-2" id="password" name="password" value="**********" disabled readonly>


                                                    </div>

                                                    <div class="col px-1 mb-2">
                                                        <p>To change password, contact admin.</p>
<!--                                                        <button type="button" class="btn btn-secondary" onclick="changePassword()" style="margin-top: 7px;">Change Password</button>-->

                                                    </div>
                                                </div>


                                            </form>


                                        </div>

                                    </div>

                                    <div class="card-footer">
                                        <button class="btn btn-primary btn-block" type="submit" onclick="updateProfile()" >Update</button>
                                    </div>

                                <div id="updateSuccess" class="col-sm-12 alert alert-success" style="display:none" >Update Successful!</div>


                            </div>
                            </div>


                            <div id="tab3" style="display: none">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        Reset Password
                                    </div>
                                    <div class="card-body">


                                        <form >

                                            <div class="col px-1 mb-2">
                                                <label for="password" class="ms-2 position-absolute" style="margin-top: -0.25rem !important">
                                                    <span class="h6 small bg-white text-muted px-1">Password</span>
                                                </label>
                                                <input type="text" class="form-control mt-2" id="password" name="newPassword" required="required">
                                                <!--                                        <span id="titleError" class="alert alert-danger col-sm-12" style="display:none"></span>-->

                                            </div>

                                            <br/>


                                            <div class="col px-1 mb-2">
                                                <label for="password" class="ms-2 position-absolute" style="margin-top: -0.25rem !important">
                                                    <span class="h6 small bg-white text-muted px-1">Confirm Password</span>
                                                </label>
                                                <input type="password" class="form-control mt-2" id="matchPassword" >
                                                <!--                                        <span id="titleError" class="alert alert-danger col-sm-12" style="display:none"></span>-->

                                            </div>

                                            <br/>

                                            <p> A code has been send to your email. Please enter the code below.</p>

                                            <div class="col px-1 mb-2">
                                                <label for="token" class="ms-2 position-absolute" style="margin-top: -0.25rem !important">
                                                    <span class="h6 small bg-white text-muted px-1">Your token</span>
                                                </label>
                                                <input type="text" class="form-control mt-2" id="token" name="token" th:value="${param.token}">
                                                <!--                                        <span id="titleError" class="alert alert-danger col-sm-12" style="display:none"></span>-->

                                            </div>

                                            <br/>
                                            <div id="globalError" class="col-sm-12 alert alert-danger" style="display:none" th:utext="#{PasswordMatches.user}">error</div>


                                            <div class="col-sm-12">

                                                <button class="btn btn-primary btn-block" type="submit" onclick="savePass()" th:utext="#{message.updatePassword}">submit</button>
                                                <button class="btn btn-secondary btn-block" type="submit" onclick="resetDivs()">Cancel</button>
                                            </div>
                                        </form>


                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                        <br>

            </div>
            <!-- /.container-fluid -->


        </div>
        <!-- End of Main Content -->

        <!-- Footer -->
         <footer th:replace="footer :: footer"></footer>
        <!-- End of Footer -->

    </div>
    <!-- End of Content Wrapper -->

</div>
<!-- End of Page Wrapper -->

<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>


<script>


    function editProfile() {
        var displayContent = document.getElementById("tab1");
        var editContent = document.getElementById("tab2");
        var passwordResetContent = document.getElementById("tab3");
        displayContent.style.display = 'none';
        editContent.style.display = 'block';
        passwordResetContent.style.display = 'none';
    }


    function resetDivs() {
        var displayContent = document.getElementById("tab1");
        var editContent = document.getElementById("tab2");
        var passwordResetContent = document.getElementById("tab3");
        displayContent.style.display = 'block';
        editContent.style.display = 'none';
        passwordResetContent.style.display = 'none';

    }
    async function updateProfile() {

        var loadingModal = document.getElementById("loadingModal");
        loadingModal.style.display='block';

        let formData = new FormData();
        var teamName = document.getElementById("teamName").value;

        formData.append("profileImageUpload", profileImageUpload.files[0]);
        formData.append("teamName", teamName);

        let response = await fetch('/settings/update', {
            method: "POST",
            body: formData
        });

        const responseBody = await response.text();
        const parsedData = JSON.parse(responseBody);


        if (response.status == 200) {
            document.getElementById("updateSuccess").style.display = 'block';
            setTimeout(() => {
                afterReceivingUpdateProfileResponse(parsedData);
            }, 300);

        }
    }

    function afterReceivingUpdateProfileResponse(parsedData){
        document.getElementById("updateSuccess").style.display = 'none';
        var loadingModal = document.getElementById("loadingModal");
        loadingModal.style.display='none';

        var displayContent = document.getElementById("tab1");
        var editContent = document.getElementById("tab2");
        var passwordResetContent = document.getElementById("tab3");
        displayContent.style.display = 'block';
        editContent.style.display = 'none';
        passwordResetContent.style.display = 'none';

        var proPicMain = document.getElementById("proPicMain");
        var proPicSub = document.getElementById("proPicSub");
        var teamNameMain = document.getElementById("teamNameMain");
        var teamName = document.getElementById("teamName");

        teamNameMain.textContent = "Team Name: " + parsedData.teamName;
        teamName.textContent = parsedData.teamName;
        proPicMain.src = parsedData.pathToProPic;
        proPicSub.src = parsedData.pathToProPic;

    }

    function changePassword() {
        var displayContent = document.getElementById("tab1");
        var editContent = document.getElementById("tab2");
        var passwordResetContent = document.getElementById("tab3");
        displayContent.style.display = 'none';
        editContent.style.display = 'none';
        passwordResetContent.style.display = 'block';
    }
</script>


<script th:inline="javascript">
    var serverContext = [[@{/}]];

        $(document).ready(function () {
            $('form').submit(function(event) {
                savePass(event);
            });

            $(":password").keyup(function(){
                if($("#password").val() != $("#matchPassword").val()){
                    $("#globalError").show().html(/*[[#{PasswordMatches.user}]]*/);
                }else{
                    $("#globalError").html("").hide();
                }
            });

            options = {
                common: {minChar:8},
                ui: {
                    showVerdictsInsideProgressBar:true,
                    showErrors:true,
                    errorMessages:{
                        wordLength: /*[[#{error.wordLength}]]*/,
                        wordNotEmail: /*[[#{error.wordNotEmail}]]*/,
                        wordSequences: /*[[#{error.wordSequences}]]*/,
                        wordLowercase: /*[[#{error.wordLowercase}]]*/,
                        wordUppercase: /*[[#{error.wordUppercase}]]*/,
                        wordOneNumber: /*[[#{error.wordOneNumber}]]*/,
                        wordOneSpecialChar: /*[[#{error.wordOneSpecialChar}]]*/
                    }
                }
            };
            $('#password').pwstrength(options);
        });


    function savePass(event){
        event.preventDefault();
        $(".alert").html("").hide();
        $(".error-list").html("");
        if($("#password").val() != $("#matchPassword").val()){
            $("#globalError").show().html(/*[[#{PasswordMatches.user}]]*/);
            return;
        }
        var formData= $('form').serialize();
        $.post(serverContext + "user/savePassword",formData ,function(data){
            window.location.href = serverContext + "login?message="+data.message;
        })
            .fail(function(data) {
                if(data.responseJSON.error.indexOf("InternalError") > -1){
                    window.location.href = serverContext + "login?message=" + data.responseJSON.message;
                }
                else{
                    var errors = $.parseJSON(data.responseJSON.message);
                    $.each( errors, function( index,item ){
                        $("#globalError").show().html(item.defaultMessage);
                    });
                    errors = $.parseJSON(data.responseJSON.error);
                    $.each( errors, function( index,item ){
                        $("#globalError").show().append(item.defaultMessage+"<br/>");
                    });
                }
            });
    }






</script>

<!-- Bootstrap core JavaScript-->

<script th:src="@{/app-assets/vendor/jquery/jquery.min.js}"></script>
<script th:src="@{/app-assets/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>

<!-- Core plugin JavaScript-->
<script th:src="@{/app-assets/vendor/jquery-easing/jquery.easing.min.js}"></script>

<!-- Custom scripts for all pages-->
<script th:src="@{/app-assets/js/sb-admin-2.min.js}"></script>

<!-- Page level plugins -->
<!--<script th:src="@{/app-assets/vendor/chart.js/Chart.min.js}"></script>-->

<!--&lt;!&ndash; Page level custom scripts &ndash;&gt;-->
<!--<script th:src="@{/app-assets/js/demo/chart-area-demo.js}"></script>-->
<!--<script th:src="@{/app-assets/js/demo/chart-pie-demo.js}"></script>-->

</body>

</html>




